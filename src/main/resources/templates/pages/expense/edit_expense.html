<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/default}"
>
  <head>
    <title>Expense Management</title>
    <style>
      .title-information {
        background-color: var(--bs-primary-border-subtle);
        color: var(--bs-primary-text-emphasis);
        border: none;
      }
      .section-title {
        margin-bottom: 1rem;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 0.5rem;
        font-weight: bold;
        color: white;
      }
      .badge-low {
        background-color: var(--bs-success);
      }
      .badge-high {
        background-color: var(--bs-danger);
      }
      .badge-medium {
        background-color: var(--bs-warning);
        color: #000;
      }
    </style>

    <script>
      /*
          jQuey
        */
      $(document).ready(function () {
        $("#enablePrediction").change(function () {
          if (!$(this).is(":checked")) {
            $("#cardPredictionResult").addClass("d-none");
          }
        });

        $("#business").change(function () {
          const businessId = $(this).val();
          const predictionEnabled = $("#enablePrediction").is(":checked");

          if (!businessId || !predictionEnabled) {
            // Hide everything if disabled
            $("#cardPredictionResult").addClass("d-none");
            $("#summaryCard").addClass("d-none");
            $("#predictionsSection").addClass("d-none");
            $("#recommendationsSection").addClass("d-none");
            $("#loadingSpinner").addClass("d-none");
            return;
          }

          // Clear previous results and show loading spinner
          $("#summaryCard").addClass("d-none");
          $("#predictionsSection").addClass("d-none");
          $("#recommendationsSection").addClass("d-none");
          $("#loadingSpinner").removeClass("d-none");

          $.ajax({
            url: "/api/expense/predict",
            type: "POST",
            dataType: "json",
            data: { businessId },
            success: function (data) {
              showPrediction(data);
            },
            error: function (e) {
              $("#loadingSpinner").addClass("d-none");
              alert(`Error fetching data. ${e.responseText}.`);
            },
          });
        });
      });

      function showPrediction(data) {
        $("#cardPredictionResult").removeClass("d-none");
        // Hide spinner
        $("#loadingSpinner").addClass("d-none");

        // Show summary
        $("#currentBalance").text(data.currentBalance.toFixed(2));
        let riskClass = "badge-low";
        if (data.riskLevel === "HIGH") riskClass = "badge-high";
        else if (data.riskLevel === "MEDIUM") riskClass = "badge-medium";

        $("#riskLevel")
          .text(data.riskLevel)
          .removeClass()
          .addClass(`badge ${riskClass}`);
        $("#summaryCard").removeClass("d-none");

        // Fill predictions
        const predictionsHtml = data.predictions
          .map(
            (p) => `
          <tr>
            <td class="text-capitalize">${p.category}</td>
            <td>$${p.predictedAmount}</td>
            <td>${p.predictedDateFormatted}</td>
            <td>${p.reason}</td>
          </tr>
        `
          )
          .join("");
        $("#predictionsBody").html(predictionsHtml);
        $("#predictionsSection").toggleClass(
          "d-none",
          !data.predictions.length
        );

        // Fill recommendations
        const recommendationsHtml = data.recommendations
          .map(
            (r) => `
          <li class="list-group-item">
            <span class="fw-bold">Priority ${r.priority}:</span> ${r.message}
          </li>
        `
          )
          .join("");
        $("#recommendationsList").html(recommendationsHtml);
        $("#recommendationsSection").toggleClass(
          "d-none",
          !data.recommendations.length
        );
      }
    </script>
  </head>

  <body>
    <section layout:fragment="page">
      <!-- Error message -->
      <div
        th:if="${error}"
        class="alert alert-danger alert-dismissible fade show"
        role="alert"
      >
        <span th:text="${error}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>

      <form action="/expense" method="POST">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 th:text="${title}" class="fw-bolder"></h5>
          <div class="d-flex justify-content-between align-items-center">
            <!-- Switch enable prediction -->
            <div class="form-check form-switch me-2 mb-0">
              <input
                class="form-check-input"
                type="checkbox"
                id="enablePrediction"
                checked
              />
              <label class="form-check-label" for="enablePrediction"
                >Enable prediction expense</label
              >
            </div>

            <button type="submit" class="btn btn-primary text-white me-1">
              Save
            </button>
            <a href="/expense" class="btn btn-outline-danger">Close</a>
          </div>
        </div>

        <div class="card border-0">
          <h6 class="card-header title-information">Expense Information</h6>
          <div class="card-body">
            <!-- Business Name (Dropdown) -->
            <div class="mb-3">
              <label for="business" class="form-label">Business Name *</label>
              <select
                name="business_id"
                id="business"
                class="form-control form-select"
                required
              >
                <option value="">Select a Business</option>
                <option
                  th:each="business : ${businesses}"
                  th:value="${business.id}"
                  th:text="${business.name}"
                  th:selected="${expense != null && expense.business.id == business.id}"
                ></option>
              </select>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center my-4 d-none">
              <div
                class="spinner-border text-primary"
                role="status"
                style="width: 3rem; height: 3rem"
              >
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Fetching predictions, please wait...</p>
            </div>

            <!-- Expense prediction result -->
            <div
              id="cardPredictionResult"
              class="card mb-3 bg-primary d-none border-0"
            >
              <div class="card-header text-white">
                Prediction expense result (recent transactions last 3 months)
              </div>
              <div class="card-body">
                <!-- Summary Card -->
                <div id="summaryCard" class="card p-3 mb-4 d-none border-0">
                  <p class="mb-1">
                    <strong>üí∞ Current Balance:</strong> $<span
                      id="currentBalance"
                    ></span>
                  </p>
                  <p class="mb-0">
                    <strong>‚ö†Ô∏è Risk Level:</strong>
                    <span id="riskLevel" class="badge"></span>
                  </p>
                </div>

                <!-- Predictions Section -->
                <div id="predictionsSection" class="mb-4 d-none">
                  <div class="section-title">üìä Predictions</div>
                  <div class="card p-3 border-0">
                    <div class="table-responsive">
                      <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                          <tr>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Reason</th>
                          </tr>
                        </thead>
                        <tbody id="predictionsBody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- Recommendations Section -->
                <div id="recommendationsSection" class="d-none">
                  <div class="section-title">üí° Recommendations</div>
                  <div class="card p-3 border-0">
                    <ul
                      class="list-group list-group-flush"
                      id="recommendationsList"
                    ></ul>
                  </div>
                </div>
              </div>
            </div>

            <!-- Balance Name (Dropdown) -->
            <div class="mb-3">
              <label for="balance" class="form-label">Balance Name *</label>
              <select
                name="balance_id"
                id="balance"
                class="form-control form-select"
                required
              >
                <option disabled value="">Select a Balance</option>
                <option
                  th:each="balance : ${balances}"
                  th:if="${balance.balance > 0}"
                  th:value="${balance.id}"
                  th:text="${ balance.name + ' ( ' + balance.balanceFormatted + ' )' }"
                  th:selected="${expense != null && expense.balance.id == balance.id}"
                ></option>
              </select>
            </div>

            <!-- Category Name (Dropdown) -->
            <div class="mb-3">
              <label for="category" class="form-label">Category Name *</label>
              <select
                name="transactionCategory"
                id="category"
                class="form-control form-select"
                required
              >
                <option value="">Select a Category</option>
                <option
                  th:each="category : ${categories}"
                  th:value="${category}"
                  th:text="${category}"
                  th:selected="${expense != null && expense.transactionCategory == category}"
                  class="text-capitalize"
                ></option>
              </select>
            </div>

            <!-- Amount -->
            <div class="mb-3">
              <label for="amount" class="form-label">Amount ($) *</label>
              <input
                type="number"
                name="amount"
                id="amount"
                class="form-control"
                required
                th:value="${expense != null ? expense.amount : ''}"
                min="0.01"
                step="0.01"
              />
            </div>

            <!-- Date -->
            <div class="mb-3">
              <label for="notes" class="form-label">Date (yyyy-mm-dd) *</label>
              <div class="input-group">
                <input
                  type="date"
                  id="createdAt"
                  name="createdAt"
                  class="form-control"
                  required
                  th:value="${expense != null ? expense.getCreatedAtDate : ''}"
                />
                <span class="input-group-text" style="cursor: pointer">
                  <i class="bi bi-calendar4"></i>
                </span>
              </div>
            </div>

            <!-- Notes -->
            <div class="mb-3">
              <label for="notes" class="form-label">Notes</label>
              <textarea
                name="notes"
                id="notes"
                class="form-control"
                rows="3"
                th:text="${expense != null ? expense.notes : ''}"
              ></textarea>
            </div>

            <!-- Hidden Fields -->
            <input type="hidden" name="transactionType" value="Expense" />
            <input
              type="hidden"
              name="id"
              th:value="${expense != null ? expense.id : ''}"
            />
          </div>
        </div>
      </form>
    </section>
  </body>
</html>

<!-- Initialize Flatpickr -->
<script>
  flatpickr("#createdAt", {});
</script>
